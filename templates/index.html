<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.1/font/bootstrap-icons.min.css"
        rel="stylesheet">
    <style>
        body {
            background-color: #0f0f23;
            color: #cccccc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
        }

        .main-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .content-area {
            flex: 1;
            display: flex;
            min-height: 0;
        }

        .tree-panel {
            width: 400px;
            min-width: 250px;
            max-width: 500px;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            resize: horizontal;
            overflow: hidden;
        }

        .tree-header {
            background: linear-gradient(90deg, #0f3460 0%, #16537e 100%);
            padding: 15px;
            border-bottom: 1px solid #333;
        }

        .tree-content {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .preview-panel {
            flex: 1;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .preview-header {
            background: linear-gradient(90deg, #16537e 0%, #0f3460 100%);
            padding: 15px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: between;
            align-items: center;
        }

        .preview-content {
            flex: 1;
            padding: 20px;
            overflow: auto;
        }

        .info-panel {
            width: 350px;
            min-width: 300px;
            max-width: 500px;
            background: linear-gradient(135deg, #16213e 0%, #1a1a2e 100%);
            border-left: 1px solid #333;
            display: flex;
            flex-direction: column;
            resize: horizontal;
            overflow: hidden;
        }

        .info-header {
            background: linear-gradient(90deg, #0f3460 0%, #16537e 100%);
            padding: 15px;
            border-bottom: 1px solid #333;
        }

        .info-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        /* Tree Styles */
        .tree-item {
            padding: 8px 12px;
            margin: 2px 0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: normal;
            /* allow wrapping */
            word-break: break-word;
            /* break long words if needed */
            overflow-wrap: break-word;
            /* fallback for older browsers */
        }

        .tree-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(3px);
        }

        .tree-item.selected {
            background: linear-gradient(90deg, #4a90e2 0%, #357abd 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(74, 144, 226, 0.3);
        }

        .tree-item.folder {
            color: #4a90e2;
            font-weight: 500;
        }

        .tree-item.file {
            color: #ffffff;
            padding-left: 24px;
        }

        .tree-item i {
            font-size: 14px;
            width: 16px;
            text-align: center;
        }

        /* Search Box */
        .search-box {
            position: sticky;
            top: 0;
            background: rgba(15, 15, 35, 0.95);
            backdrop-filter: blur(10px);
            padding: 10px;
            border-bottom: 1px solid #333;
            margin-bottom: 10px;
        }

        .search-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #333;
            border-radius: 8px;
            color: #cccccc;
            width: 100%;
            padding: 8px 12px;
        }

        .search-input:focus {
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
            outline: none;
            background: rgba(255, 255, 255, 0.15);
        }

        /* IES Table Styles */
        .ies-table {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .ies-table table {
            margin: 0;
        }

        .ies-table th {
            background: linear-gradient(90deg, #16537e 0%, #0f3460 100%);
            color: white;
            padding: 12px;
            font-weight: 600;
            border: none;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .ies-table td {
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            color: #ffffff;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }

        .ies-table tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Statistics Cards */
        .stat-card {
            background: linear-gradient(135deg, rgba(74, 144, 226, 0.1) 0%, rgba(53, 122, 189, 0.1) 100%);
            border: 1px solid rgba(74, 144, 226, 0.3);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            transition: transform 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(74, 144, 226, 0.2);
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #4a90e2;
        }

        .stat-label {
            color: #b0b0b0;
            font-size: 0.9rem;
        }

        /* Tree Collapse Styles */
        .tree-children {
            margin-left: 20px;
            overflow: hidden;
            transform-origin: top;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out, background-color 0.3s ease-out;
            transform: scaleY(0);
            opacity: 0;
        }

        /* Expanded subfolders */
        .tree-children.expanded {
            transform: scaleY(1);
            opacity: 1;
            background-color: rgba(38, 56, 108, 0.6);
            /* slightly darker */
            border-radius: 4px;
            padding-left: 10px;
        }



        .file-icon {
            color: #666;
        }

        .file-icon.ies {
            color: #f39c12;
        }

        .file-icon.xml {
            color: #e74c3c;
        }

        .file-icon.lua {
            color: #9b59b6;
        }

        .file-icon.png,
        .file-icon.jpg,
        .file-icon.jpeg,
        .file-icon.bmp,
        .file-icon.tga {
            color: #2ecc71;
        }

        /* Loading States */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #666;
        }

        .spinner {
            border: 3px solid rgba(74, 144, 226, 0.3);
            border-top: 3px solid #4a90e2;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #4a90e2 0%, #357abd 100%);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #357abd 0%, #2e6da4 100%);
        }

        /* Navigation Header */
        .navbar {
            background: linear-gradient(90deg, #0f3460 0%, #16537e 100%);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .navbar-brand {
            color: white !important;
            font-weight: bold;
            font-size: 1.3rem;
        }

        /* Breadcrumb */
        .breadcrumb-container {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px 15px;
            border-bottom: 1px solid #333;
        }

        .breadcrumb {
            margin: 0;
            background: none;
        }

        .breadcrumb-item a {
            color: #4a90e2;
            text-decoration: none;
        }

        .breadcrumb-item a:hover {
            color: #357abd;
        }

        .breadcrumb-item.active {
            color: #ffffff;
        }

        /* Version Selector */
        .version-selector {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid #333;
            border-radius: 6px;
            color: #cccccc;
            padding: 5px 10px;
            font-size: 0.9rem;
        }

        .version-selector:focus {
            border-color: #4a90e2;
            box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
            outline: none;
        }
    </style>
</head>

<body>
    <div class="main-container">
        <!-- Navigation Header -->
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">
                    <i class="bi bi-archive"></i>
                    Tree of Savior Archive Viewer
                </a>
                <div class="d-flex align-items-center text-light">
                    <small class="me-3">
                        <i class="bi bi-files"></i>
                        {{ total_files }} files
                    </small>
                    <small>
                        <i class="bi bi-hdd"></i>
                        Ready
                    </small>
                </div>
            </div>
        </nav>

        <div class="content-area">
            <!-- Left Panel - File Tree -->
            <div class="tree-panel">
                <div class="tree-header">
                    <h6 class="mb-0">
                        <i class="bi bi-folder-open"></i>
                        File Browser
                    </h6>
                </div>

                <div class="search-box">
                    <input type="text" class="search-input" placeholder="Search files..." id="fileSearch">
                </div>

                <div class="tree-content" id="fileTree">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading file tree...
                    </div>
                </div>
            </div>

            <!-- Middle Panel - Preview -->
            <div class="preview-panel">
                <div class="preview-header">
                    <div>
                        <h6 class="mb-0" id="previewTitle">
                            <i class="bi bi-eye"></i>
                            Preview
                        </h6>
                        <div class="breadcrumb-container">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb" id="breadcrumb">
                                    <li class="breadcrumb-item active">Select a file to preview</li>
                                </ol>
                            </nav>
                        </div>
                    </div>
                    <div id="versionControls" style="display: none;">
                        <select class="version-selector" id="versionSelect">
                            <option value="0">Version 1</option>
                        </select>
                    </div>
                </div>

                <div class="preview-content" id="previewContent">
                    <div class="text-center text-light mt-5">
                        <i class="bi bi-file-earmark" style="font-size: 4rem; opacity: 0.3;"></i>
                        <h5 class="mt-3">No file selected</h5>
                        <p>Select a file from the tree to preview its contents</p>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Information -->
            <div class="info-panel">
                <div class="info-header">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle"></i>
                        Information
                    </h6>
                </div>

                <div class="info-content">
                    <!-- Statistics -->
                    <div class="stat-card">
                        <div class="stat-value">{{ total_files }}</div>
                        <div class="stat-label">Total Files</div>
                    </div>



                    <!-- File Information Panel -->
                    <div id="fileInfo" style="display: none;">
                        <h6 class="mt-4 mb-3">File Details</h6>
                        <div id="fileDetails"></div>
                    </div>



                    <h6 class="mt-4 mb-3">Duplicate Statistics</h6>
                    <div class="stat-card">
                        <div class="stat-value">{{ duplicates_xac + duplicates_xsm + duplicates_xsmtime + duplicates_xpm
                            + duplicates_dds }}</div>
                        <div class="stat-label">Total Duplicates</div>
                    </div>

                    <div class="row g-2">
                        <div class="col-6">
                            <div class="stat-card">
                                <div class="stat-value">{{ duplicates_xac }}</div>
                                <div class="stat-label">XAC</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card">
                                <div class="stat-value">{{ duplicates_xsm }}</div>
                                <div class="stat-label">XSM</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card">
                                <div class="stat-value">{{ duplicates_xsmtime }}</div>
                                <div class="stat-label">XSM Time</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card">
                                <div class="stat-value">{{ duplicates_xpm }}</div>
                                <div class="stat-label">XPM</div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="stat-card">
                                <div class="stat-value">{{ duplicates_dds }}</div>
                                <div class="stat-label">DDS</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script>
        class ArchiveViewer {
            constructor() {
                this.currentFolder = "";
                this.currentFile = null;
                this.fileVersions = [];
                this.selectedVersion = 0;
                this.init();
            }

            init() {
                this.loadRootFolders();
                this.setupEventListeners();
            }

            setupEventListeners() {
                // Search functionality
                document.getElementById('fileSearch').addEventListener('input', (e) => {
                    this.searchFiles(e.target.value);
                });

                // Version selector
                document.getElementById('versionSelect').addEventListener('change', (e) => {
                    this.selectedVersion = parseInt(e.target.value);

                    // Load the preview
                    this.loadFilePreview(this.currentFile, this.selectedVersion);

                    // Update file info for the selected version
                    const fileInfo = this.fileVersions[this.selectedVersion] || this.fileVersions[0];
                    this.updateFileDetails(fileInfo);
                });

            }

            async loadRootFolders() {
                try {
                    const response = await fetch('/api/folder/shallow?folder_name=');
                    if (!response.ok) throw new Error('Failed to load root folders');

                    const data = await response.json();
                    this.renderFolderTree(data);
                } catch (error) {
                    document.getElementById('fileTree').innerHTML = `
                        <div class="text-danger p-3">
                            <i class="bi bi-exclamation-triangle"></i>
                            Error loading file tree: ${error.message}
                        </div>
                    `;
                }
            }

            async loadFolder(folderName) {
                try {
                    const response = await fetch(`/api/folder/shallow?folder_name=${encodeURIComponent(folderName)}`);
                    if (!response.ok) throw new Error('Failed to load folder');

                    const data = await response.json();
                    return data;
                } catch (error) {
                    console.error('Error loading folder:', error);
                    return null;
                }
            }

            renderFolderTree(data, parentElement = null) {
                const container = parentElement || document.getElementById('fileTree');
                container.innerHTML = '';

                // Sort subfolders case-insensitively
                const sortedSubfolders = [...data.subfolders].sort((a, b) =>
                    a.toLowerCase().localeCompare(b.toLowerCase())
                );

                // Sort files case-insensitively
                const sortedFiles = [...data.files].sort((a, b) =>
                    a.toLowerCase().localeCompare(b.toLowerCase())
                );

                // Render sorted subfolders
                sortedSubfolders.forEach(folder => {
                    const folderElement = this.createFolderElement(folder, data.folder_name);
                    container.appendChild(folderElement);
                });

                // Render sorted files
                sortedFiles.forEach(file => {
                    const fileElement = this.createFileElement(file, data.folder_name);
                    container.appendChild(fileElement);
                });
            }

            createFolderElement(folderName, parentPath) {
                const element = document.createElement('div');
                element.className = 'tree-item folder';
                element.innerHTML = `
                    <i class="bi bi-folder"></i>
                    <span>${folderName}</span>
                `;

                let childContainer = null;
                let isExpanded = false;

                element.addEventListener('click', async () => {
                    if (isExpanded) {
                        // Collapse folder
                        isExpanded = false;
                        element.querySelector('i').className = 'bi bi-folder';
                        if (childContainer) {
                            childContainer.classList.remove('expanded');
                            childContainer.classList.add('collapsed');
                            setTimeout(() => {
                                childContainer.remove();
                                childContainer = null;
                            }, 300);
                        }
                    } else {
                        // Expand folder
                        isExpanded = true;
                        element.querySelector('i').className = 'bi bi-folder-open';

                        const fullPath = parentPath ? `${parentPath}/${folderName}` : folderName;
                        const folderData = await this.loadFolder(fullPath);

                        if (folderData) {
                            // Create container for children
                            childContainer = document.createElement('div');
                            childContainer.className = 'tree-children collapsed';

                            // Sort subfolders case-insensitively
                            const sortedSubfolders = [...folderData.subfolders].sort((a, b) =>
                                a.toLowerCase().localeCompare(b.toLowerCase())
                            );

                            // Sort files case-insensitively
                            const sortedFiles = [...folderData.files].sort((a, b) =>
                                a.toLowerCase().localeCompare(b.toLowerCase())
                            );

                            // Add sorted subfolders
                            sortedSubfolders.forEach(subfolder => {
                                const subfolderElement = this.createFolderElement(subfolder, fullPath);
                                childContainer.appendChild(subfolderElement);
                            });

                            // Add sorted files
                            sortedFiles.forEach(file => {
                                const fileElement = this.createFileElement(file, fullPath);
                                childContainer.appendChild(fileElement);
                            });

                            // Insert after current folder
                            element.parentNode.insertBefore(childContainer, element.nextSibling);

                            // Trigger expansion animation
                            setTimeout(() => {
                                childContainer.classList.remove('collapsed');
                                childContainer.classList.add('expanded');
                            }, 10);
                        }
                    }
                });

                return element;
            }

            createFileElement(fileName, parentPath) {
                const element = document.createElement('div');
                element.className = 'tree-item file';

                const ext = fileName.split('.').pop().toLowerCase();
                const iconClass = this.getFileIcon(ext);

                element.innerHTML = `
                    <i class="bi ${iconClass} file-icon ${ext}"></i>
                    <span>${fileName}</span>
                `;

                element.addEventListener('click', () => {
                    // Remove previous selection
                    document.querySelectorAll('.tree-item.selected').forEach(item => {
                        item.classList.remove('selected');
                    });

                    // Select this item
                    element.classList.add('selected');

                    const fullPath = parentPath ? `${parentPath}/${fileName}` : fileName;
                    this.loadFileInfo(fullPath);
                });

                return element;
            }

            getFileIcon(extension) {
                const icons = {
                    'ies': 'bi-table',
                    'xml': 'bi-code-slash',
                    'skn': 'bi-code-slash',
                    '3deffect': 'bi-code-slash',
                    '3dprop': 'bi-code-slash',
                    '3dworld': 'bi-code-slash',
                    '3drender': 'bi-code-slash',
                    'fx': 'bi-code-slash',
                    'x': 'bi-code-slash',
                    'sani': 'bi-code-slash',
                    'effect': 'bi-code-slash',
                    'sprbin': 'bi-code-slash',
                    'lua': 'bi-file-code',
                    'png': 'bi-image',
                    'jpg': 'bi-image',
                    'jpeg': 'bi-image',
                    'bmp': 'bi-image',
                    'tga': 'bi-image',
                    'txt': 'bi-file-text'
                };
                return icons[extension] || 'bi-file-earmark';
            }

            async loadFileInfo(filePath) {
                try {
                    this.currentFile = filePath;

                    // Load file versions
                    const response = await fetch(`/api/file/fullpath?full_path=${encodeURIComponent(filePath)}`);
                    if (!response.ok) throw new Error('File not found');

                    this.fileVersions = await response.json();
                    this.updateVersionSelector();
                    this.updateBreadcrumb(filePath);
                    this.updateFileDetails(this.fileVersions[0]);
                    this.loadFilePreview(filePath, 0);

                } catch (error) {
                    console.error('Error loading file info:', error);
                    this.showError('Failed to load file information');
                }
            }

            updateVersionSelector() {
                const selector = document.getElementById('versionSelect');
                const controls = document.getElementById('versionControls');

                if (this.fileVersions.length > 1) {
                    controls.style.display = 'block';
                    selector.innerHTML = this.fileVersions.map((version, index) =>
                        `<option value="${index}">Version ${index + 1}</option>`
                    ).join('');
                } else {
                    controls.style.display = 'none';
                }
            }

            updateBreadcrumb(filePath) {
                const breadcrumb = document.getElementById('breadcrumb');
                const parts = filePath.split('/');

                breadcrumb.innerHTML = parts.map((part, index) => {
                    if (index === parts.length - 1) {
                        return `<li class="breadcrumb-item active">${part}</li>`;
                    } else {
                        return `<li class="breadcrumb-item"><a href="#">${part}</a></li>`;
                    }
                }).join('');
            }

            updateFileDetails(fileInfo) {
                document.getElementById('fileInfo').style.display = 'block';

                const details = document.getElementById('fileDetails');
                details.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-label">Container</div>
                        <div class="stat-value" style="font-size: 1rem;">${fileInfo.container_name}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Compressed Size</div>
                        <div class="stat-value" style="font-size: 1rem;">${this.formatBytes(fileInfo.file_size_compressed)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Uncompressed Size</div>
                        <div class="stat-value" style="font-size: 1rem;">${this.formatBytes(fileInfo.file_size_uncompressed)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">CRC32</div>
                        <div class="stat-value" style="font-size: 1rem;">${fileInfo.crc32.toString(16).toUpperCase()}</div>
                    </div>
                        <div class="stat-card">
                        <div class="stat-label">File Path</div>
                        <div class="stat-value" style="font-size: 1rem;">${fileInfo.file_path.toString()}</div>
                    </div>
                    <div class="mt-3">
                        <a href="/api/file/download?path=${encodeURIComponent(this.currentFile)}&version=${this.selectedVersion || 0}" 
                        class="btn btn-primary">
                        <i class="bi bi-download"></i>
                            Download File
                        </a>
                    </div>
                `;
            }

            async loadFilePreview(filePath, version = 0) {
                const previewContent = document.getElementById('previewContent');
                previewContent.innerHTML = `
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading preview...
                    </div>
                `;

                try {
                    const response = await fetch(`/api/file/preview?path=${encodeURIComponent(filePath)}&version=${version}`);

                    if (!response.ok) throw new Error('Failed to load preview');

                    const contentType = response.headers.get('content-type');

                    if (contentType.includes('application/json')) {
                        // IES file - render as table
                        const iesData = await response.json();
                        this.renderIESTable(iesData);
                    } else if (contentType.includes('text/plain')) {
                        // Text file - render as code
                        const text = await response.text();
                        this.renderTextContent(text, filePath);
                    } else if (contentType.includes('image/')) {
                        // Image file - render as image
                        const blob = await response.blob();
                        this.renderImageContent(blob);
                    } else {
                        // Binary file - show download option
                        this.renderBinaryContent(filePath, version);
                    }

                } catch (error) {
                    this.showError('Failed to load file preview');
                }
            }

            renderIESTable(iesData) {
                const previewContent = document.getElementById('previewContent');

                if (!iesData.data || iesData.data.length === 0) {
                    previewContent.innerHTML = '<div class="text-light text-center p-4">No data available</div>';
                    return;
                }

                let sortedColumn = [...iesData.columns].sort((a, b) => a.decl_idx - b.decl_idx);
                sortedColumn = sortedColumn.sort((a, b) => a.type_data - b.type_data);

                // Create table header from columns
                const headers = sortedColumn.map(col => col.name || col.column).filter(name => name.trim());

                let tableHTML = `
<div class="ies-table">
    <div class="mb-3">
        <br>
        <h4 class="text-center text-light">IES Filename : ${iesData.header.idspace}</h4>
        <small class="text-muted">
            Version: ${iesData.header.version} | 
            Fields: ${iesData.header.num_field} | 
            Columns: ${iesData.header.num_column}
        </small>
    </div>
    <div class="table-responsive">
        <table class="table table-sm table-dark table-striped table-bordered align-middle text-center">
            <thead class="table-secondary text-dark">
                <tr>
                    <th scope="col">Number</th>
                    <th scope="col">Index</th>
`;

                headers.forEach(header => {
                    tableHTML += `<th scope="col">${header}</th>`;
                });

                tableHTML += `
                </tr>
            </thead>
            <tbody>
`;

                // Add sorted data rows
                iesData.data.forEach((row, index) => {
                    tableHTML += `<tr><td>${row.index_data}</td>`;

                    // Add row text data
                    if (row.row_text) {
                        tableHTML += `<td>${row.row_text.text_data}</td>`;
                    }

                    // Add float data
                    if (row.floats) {
                        row.floats.forEach(f => {
                            tableHTML += `<td>${f.float_data}</td>`;
                        });
                    }

                    // Add text data
                    if (row.texts) {
                        row.texts.forEach(t => {
                            tableHTML += `<td>${t.text_data}</td>`;
                        });
                    }

                    tableHTML += `</tr>`;
                });

                tableHTML += `
            </tbody>
        </table>
    </div>
</div>
`;

                previewContent.innerHTML = tableHTML;
            }

            renderTextContent(text, filePath) {
                const previewContent = document.getElementById('previewContent');
                const extension = filePath.split('.').pop().toLowerCase();

                previewContent.innerHTML = `
                    <div class="bg-dark p-3 rounded" style="background-color: rgba(0,0,0,0.5) !important;">
                        <pre style="color: #ffffff; margin: 0; white-space: pre-wrap; word-wrap: break-word;"><code class="language-${extension}">${this.escapeHtml(text)}</code></pre>
                    </div>
                `;
            }

            renderImageContent(blob) {
                const previewContent = document.getElementById('previewContent');
                const imageUrl = URL.createObjectURL(blob);

                previewContent.innerHTML = `
                    <div class="text-center">
                        <img src="${imageUrl}" class="img-fluid rounded shadow" style="max-height: 70vh;" alt="Preview">
                    </div>
                `;
            }

            renderBinaryContent(filePath, version) {
                const previewContent = document.getElementById('previewContent');

                previewContent.innerHTML = `
                    <div class="text-center text-light p-5">
                        <i class="bi bi-file-binary" style="font-size: 4rem; opacity: 0.3;"></i>
                        <h5 class="mt-3">Binary File</h5>
                        <p>This file cannot be previewed in the browser</p>
                        <a href="/api/file/download?path=${encodeURIComponent(filePath)}&version=${version}" 
                           class="btn btn-primary">
                            <i class="bi bi-download"></i>
                            Download File
                        </a>
                    </div>
                `;
            }

            async searchFiles(query) {
                if (!query.trim()) {
                    this.loadRootFolders();
                    return;
                }

                try {
                    const response = await fetch(`/api/file/search?file_name=${encodeURIComponent(query)}`);
                    if (!response.ok) throw new Error('Search failed');

                    const data = await response.json();
                    this.renderSearchResults(data);
                } catch (error) {
                    console.error('Search error:', error);
                }
            }

            renderSearchResults(searchData) {
                const container = document.getElementById('fileTree');
                container.innerHTML = '';

                if (searchData.found_files.length === 0) {
                    container.innerHTML = `
                        <div class="text-light p-3">
                            <i class="bi bi-search"></i>
                            No files found matching "${searchData.file_name}"
                        </div>
                    `;
                    return;
                }

                // Group files by unique path, keeping all versions
                const groupedFiles = new Map();
                searchData.found_files.forEach(file => {
                    const key = file.file_path;
                    if (!groupedFiles.has(key)) {
                        groupedFiles.set(key, []);
                    }
                    groupedFiles.get(key).push(file);
                });

                const header = document.createElement('div');
                header.className = 'p-3 border-bottom';
                header.innerHTML = `
                    <small class="text-light">
                        Found ${groupedFiles.size} unique file(s) (${searchData.found_files.length} total versions) for "${searchData.file_name}"
                    </small>
                `;
                container.appendChild(header);

                // Sort grouped files by path case-insensitively
                const sortedEntries = Array.from(groupedFiles.entries()).sort((a, b) =>
                    a[0].toLowerCase().localeCompare(b[0].toLowerCase())
                );

                sortedEntries.forEach(([filePath, versions]) => {
                    const element = document.createElement('div');
                    element.className = 'tree-item file';

                    const fileName = filePath.split('/').pop();
                    const ext = fileName.split('.').pop().toLowerCase();
                    const iconClass = this.getFileIcon(ext);

                    element.innerHTML = `
                        <i class="bi ${iconClass} file-icon ${ext}"></i>
                        <div style="flex: 1;">
                            <div class="text-light">${fileName}</div>
                            <small class="text-light">${filePath} (${versions.length} version${versions.length > 1 ? 's' : ''})</small>
                        </div>
                    `;

                    element.addEventListener('click', async () => {
                        document.querySelectorAll('.tree-item.selected').forEach(item => {
                            item.classList.remove('selected');
                        });
                        element.classList.add('selected');

                        // Navigate to the file in tree and load it
                        await this.navigateToFileInTree(filePath);
                        await this.loadFileInfo(filePath);
                    });

                    container.appendChild(element);
                });
            }

            async navigateToFileInTree(filePath) {
                // Clear search and return to tree view
                document.getElementById('fileSearch').value = '';

                // Split path into segments
                const pathSegments = filePath.split('/');
                const fileName = pathSegments.pop();

                if (pathSegments.length === 0) {
                    // File is in root, just reload root
                    await this.loadRootFolders();
                    return;
                }

                // Start from root
                await this.loadRootFolders();

                // Navigate through each folder segment
                let currentPath = '';
                let currentContainer = document.getElementById('fileTree');

                for (let i = 0; i < pathSegments.length; i++) {
                    const segment = pathSegments[i];
                    currentPath = currentPath ? `${currentPath}/${segment}` : segment;

                    // Find the folder element
                    const folderElements = currentContainer.querySelectorAll('.tree-item.folder');
                    let targetFolder = null;

                    for (const folderElement of folderElements) {
                        const folderName = folderElement.querySelector('span').textContent;
                        if (folderName === segment) {
                            targetFolder = folderElement;
                            break;
                        }
                    }

                    if (targetFolder) {
                        // Click to expand the folder
                        targetFolder.click();

                        // Wait for expansion to complete
                        await new Promise(resolve => setTimeout(resolve, 350));

                        // Update current container to the expanded children
                        const childContainer = targetFolder.nextSibling;
                        if (childContainer && childContainer.classList.contains('tree-children')) {
                            currentContainer = childContainer;
                        }
                    }
                }

                // Now find and select the file
                setTimeout(() => {
                    const fileElements = currentContainer.querySelectorAll('.tree-item.file');
                    for (const fileElement of fileElements) {
                        const fileNameSpan = fileElement.querySelector('span');
                        if (fileNameSpan && fileNameSpan.textContent === fileName) {
                            fileElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            fileElement.classList.add('selected');
                            break;
                        }
                    }
                }, 100);

                const previewContent = document.getElementById('previewContent');
                previewContent.innerHTML = `
                    <div class="text-center text-danger p-5">
                        <i class="bi bi-exclamation-triangle" style="font-size: 4rem; opacity: 0.3;"></i>
                        <h5 class="mt-3">Error</h5>
                        <p>${message}</p>
                    </div>
                `;
            }


            formatBytes(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }
        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ArchiveViewer();
        });

        // Handle panel resizing
        document.addEventListener('DOMContentLoaded', () => {
            const panels = document.querySelectorAll('.tree-panel, .info-panel');

            panels.forEach(panel => {
                let isResizing = false;

                panel.addEventListener('mousedown', (e) => {
                    if (e.offsetX > panel.offsetWidth - 10) {
                        isResizing = true;
                        document.body.style.cursor = 'col-resize';
                        e.preventDefault();
                    }
                });

                document.addEventListener('mousemove', (e) => {
                    if (isResizing) {
                        const newWidth = e.clientX - panel.offsetLeft;
                        if (newWidth >= 250 && newWidth <= 500) {
                            panel.style.width = newWidth + 'px';
                        }
                    }
                });

                document.addEventListener('mouseup', () => {
                    if (isResizing) {
                        isResizing = false;
                        document.body.style.cursor = 'default';
                    }
                });
            });
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl+F for search
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('fileSearch').focus();
            }

            // Escape to clear search
            if (e.key === 'Escape') {
                const searchInput = document.getElementById('fileSearch');
                if (searchInput === document.activeElement) {
                    searchInput.value = '';
                    searchInput.blur();
                    window.archiveViewer?.loadRootFolders();
                }
            }
        });
    </script>
</body>

</html>